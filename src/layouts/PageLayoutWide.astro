---
import { getEntry } from "astro:content";
import { Picture } from "astro-imagetools/components";
import BaseHead from "@components/BaseHead.astro";
import Header from "./../components/Header.astro";
import Footer from "./../components/Footer.astro";
import Init from "./../components/common/Init.vue";
import ContactDialog from "./../components/common/ContactDialog.vue";
import { Icon } from "astro-icon/components";
import { t } from "./../util/translate";
import { marked } from "marked";

const lang = import.meta.env.WEBSITE_LANGUAGE;
const currency = import.meta.env.CURRENCY;
const snipcartKey = import.meta.env.SNIPCART_KEY;
const { title, description, pageClass, thumbnail, og_image } = Astro.props;
const navigation = await getEntry("config", "navigation");
const about = await getEntry("config", "about");
const contact = await getEntry("config", "contact");

const props = Astro.props;
const contentClass = "plain" ? "py-0" : "py-20";
---

<!doctype html>
<html lang={lang} data-currency={currency}>
  <head>
    <BaseHead
      title={title}
      description={description}
      thumbnail={!!og_image ? og_image : thumbnail}
    />
  </head>
  <body class={`surface-base ${pageClass || ""}`}>
    <Header
      title={title}
      menu={navigation.data.main_menu}
      social={contact.data.social}
      about={about.data}
    />
    <main>
      <slot name="hero" />

      <div class="relative z-10 w-full" id="more">
        <div class="page__content container-md contentClass">
          <slot />
          <slot name="nav" />
        </div>
        <div class="pointer-events-none fixed bottom-0 z-40 w-full">
          <slot name="cart" />
        </div>
      </div>
    </main>
    <Footer>
      <slot name="footer" />
      <div class="pointer-events-none fixed bottom-0 right-0 z-50 w-full">
        <div class="container-xl flex justify-end pb-4">
          <a
            href="#top"
            aria-label={t("back_to_top")}
            class="btn btn-icon surface-primary btn-to-top pointer-events-auto opacity-0"
          >
            <Icon name="up" class="w-6" /></a
          >
        </div>
      </div>
    </Footer>
    <Init client:idle />

    {
      contact.data.form && (
        <ContactDialog client:idle contact={contact.data.form}>
          {contact.data.form.intro && (
            <div
              set:html={marked.parse(contact.data.form.intro)}
              slot="content"
            />
          )}
          <Picture
            slot="image"
            src={contact.data.form.thumbnail}
            alt={`contact`}
            sizes="50vw"
            aspect={4 / 5}
            format={["webp"]}
            fit="cover"
            layout="fill"
            placeholder="blurred"
            position="attention"
            loading="lazy"
            sizes="(max-width: 768px) 100vw, 40vw"
            breakpoints={[420, 725, 960]}
            artDirectives={[
              {
                media: "(max-width: 768px)",
                ar: 21 / 9,
                src: contact.data.form.thumbnail,
                layout: "constrained",
                breakpoints: [500, 601, 768, 820, 962, 1280, 1440, 1536, 1920],
              },
            ]}
          />
          <Icon name="close" class="w-6" />
        </ContactDialog>
      )
    }

    <script>
      const html = document.getElementsByTagName("html")[0];
      const SmoothScroll = () => {
        html.style["scroll-behavior"] = "auto";
      };
      SmoothScroll();
      document.addEventListener("astro:beforeload", SmoothScroll);
    </script>
    <style is:global>
      .page__content {
        &:empty {
          display: none;
        }
        &:has(> .richtext:empty) {
          display: none;
        }
        .img,
        iframe {
          width: calc(100% + var(--container-spacing));
          margin-left: calc(var(--spacing) * -1);
          @apply my-10 aspect-video h-auto;
          @screen md {
            width: 100%;
            margin-left: 0;
          }
        }
      }
    </style>
  </body><!-- Page Layout Wide -->
</html>
